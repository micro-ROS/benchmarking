/*****************************************************************
 * file: itm_to_str
 * author: Alexandre Malki <amalki@piap.pl
 * brief: This file is autogenerated
 *
 *****************************************************************/

#include <common-macros.h>
#include <config.h>
#include <debug.h>
#include <message.h>
#include <itm_to_str.h>

#include <libswo/libswo.h>
#include <string.h>


typedef struct {
	char buffer[MESSAGE_BUFFER_SZ_MAX];
	unsigned int written;
	bool is_init;
} itm_to_str_private_data;

static itm_to_str_private_data itm_to_str_priv_data;

/**
 * \brief TODO
 */
static size_t
itm_to_str_data_in(processing_obj * const obj, message_obj *const msg)
{
	itm_to_str_obj *its_obj = (itm_to_str_obj *) obj;
	itm_to_str_private_data	*pdata = 
				(itm_to_str_private_data *) its_obj->pdata;

	union libswo_packet *packets = (union libswo_packet *) msg->ptr(msg);
	unsigned int pkt_count = msg->length(msg) / sizeof (union libswo_packet);

	for (unsigned int i = 0; i < pkt_count; i++) {
		pdata->buffer[i] = (char) packets[i].inst.value;
	}

	pdata->written = pkt_count;
	return 0;
}

/**
 * \brief TODO
 */
static size_t 
itm_to_str_data_out(processing_obj * const obj, message_obj *const msg)
{
	itm_to_str_obj *its_obj = (itm_to_str_obj *) obj;
	itm_to_str_private_data	*pdata = 
				(itm_to_str_private_data *) its_obj->pdata;

	msg->write(msg, pdata->buffer, pdata->written);
	return pdata->written;
}

/**
 * \brief TODO
 */
int itm_to_str_init(itm_to_str_obj * const obj)
{
	processing_obj *proc_obj = (processing_obj *) obj;
	itm_to_str_private_data *pdata;

	if (processing_init(proc_obj)) {
		return -1;
	}

	proc_obj->data_in  = itm_to_str_data_in;
	proc_obj->data_out = itm_to_str_data_out;

	pdata = &itm_to_str_priv_data;

	memset(pdata->buffer, 0, sizeof(pdata->buffer));
	pdata->written = 0;
	pdata->is_init = true;
	obj->pdata = (void *) pdata;

	return 0;
}

/**
 * \brief TODO
 */
int itm_to_str_fini(itm_to_str_obj * const obj)
{
	processing_obj *proc_obj = (processing_obj *) obj;
	itm_to_str_private_data	*pdata = 
				(itm_to_str_private_data *) obj->pdata;

	if (!pdata->is_init) {
		ERROR("Processing element already de-initialized\n");
		return -1;
	}

	pdata->is_init = false;
	processing_fini(proc_obj);

	return 0;
}
